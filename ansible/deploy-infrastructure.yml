# =================================
# PLAYBOOK D'INFRASTRUCTURE KAFKA ET BASES DE DONNÃ‰ES
# =================================

---
- name: "ğŸ—„ï¸ DÃ©ploiement de l'infrastructure de donnÃ©es (Kafka, MySQL, Redis)"
  hosts: k8s_cluster
  gather_facts: yes
  become: false
  
  vars:
    infrastructure_namespace: "infrastructure"
    
  pre_tasks:
    - name: "ğŸ“‹ CrÃ©er le namespace infrastructure"
      kubernetes.core.k8s:
        name: "{{ infrastructure_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        definition:
          metadata:
            labels:
              name: "{{ infrastructure_namespace }}"
              managed-by: ansible
              component: infrastructure

  tasks:
    # =================================
    # DÃ‰PLOIEMENT KAFKA (BITNAMI)
    # =================================
    - name: "ğŸ“¦ Ajouter le repository Helm Bitnami"
      kubernetes.core.helm_repository:
        name: bitnami
        repo_url: https://charts.bitnami.com/bitnami
        
    - name: "â˜• DÃ©ployer Kafka avec Helm"
      kubernetes.core.helm:
        name: kafka
        chart_ref: bitnami/kafka
        release_namespace: "{{ infrastructure_namespace }}"
        create_namespace: true
        values:
          persistence:
            enabled: true
            size: 10Gi
          zookeeper:
            persistence:
              enabled: true
              size: 5Gi
          replicaCount: 3
          auth:
            enabled: false
          listeners:
            client:
              protocol: PLAINTEXT
            controller:
              protocol: PLAINTEXT
          controller:
            replicaCount: 3
          logRetentionBytes: 1073741824
          logRetentionHours: 168
          maxMessageBytes: 1000012
          service:
            type: ClusterIP
            ports:
              client: 9092
          metrics:
            kafka:
              enabled: true
            jmx:
              enabled: true
      tags: [kafka]

    # =================================
    # DÃ‰PLOIEMENT MYSQL
    # =================================
    - name: "ğŸ—„ï¸ DÃ©ployer MySQL avec Helm"
      kubernetes.core.helm:
        name: mysql
        chart_ref: bitnami/mysql
        release_namespace: "{{ infrastructure_namespace }}"
        values:
          auth:
            rootPassword: "{{ mysql_root_password }}"
            database: "springboot_microservices"
            username: "{{ mysql_username }}"
            password: "{{ mysql_password }}"
          primary:
            persistence:
              enabled: true
              size: 20Gi
              storageClass: gp3
            resources:
              requests:
                memory: 1Gi
                cpu: 500m
              limits:
                memory: 2Gi
                cpu: 1000m
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
          service:
            type: ClusterIP
            ports:
              mysql: 3306
      tags: [mysql]

    # =================================
    # DÃ‰PLOIEMENT REDIS
    # =================================
    - name: "ğŸ”´ DÃ©ployer Redis avec Helm"
      kubernetes.core.helm:
        name: redis
        chart_ref: bitnami/redis
        release_namespace: "{{ infrastructure_namespace }}"
        values:
          auth:
            enabled: true
            password: "{{ redis_password }}"
          master:
            persistence:
              enabled: true
              size: 5Gi
              storageClass: gp3
            resources:
              requests:
                memory: 512Mi
                cpu: 250m
              limits:
                memory: 1Gi
                cpu: 500m
          replica:
            replicaCount: 2
            persistence:
              enabled: true
              size: 5Gi
              storageClass: gp3
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
          service:
            type: ClusterIP
            ports:
              redis: 6379
      tags: [redis]

    # =================================
    # DÃ‰PLOIEMENT PROMETHEUS STACK
    # =================================
    - name: "ğŸ“Š Ajouter le repository Helm Prometheus"
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: "ğŸ“ˆ DÃ©ployer la stack de monitoring Prometheus"
      kubernetes.core.helm:
        name: monitoring-stack
        chart_ref: prometheus-community/kube-prometheus-stack
        release_namespace: "{{ infrastructure_namespace }}"
        values:
          prometheus:
            prometheusSpec:
              storageSpec:
                volumeClaimTemplate:
                  spec:
                    storageClassName: gp3
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 10Gi
              resources:
                requests:
                  memory: 1Gi
                  cpu: 500m
                limits:
                  memory: 2Gi
                  cpu: 1000m
          grafana:
            adminPassword: "{{ grafana_admin_password }}"
            persistence:
              enabled: true
              size: 5Gi
              storageClassName: gp3
            service:
              type: ClusterIP
              port: 3000
          alertmanager:
            alertmanagerSpec:
              storage:
                volumeClaimTemplate:
                  spec:
                    storageClassName: gp3
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 2Gi
      tags: [monitoring]

  post_tasks:
    - name: "â³ Attendre que Kafka soit prÃªt"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: StatefulSet
        name: kafka
        namespace: "{{ infrastructure_namespace }}"
        wait: true
        wait_condition:
          type: Ready
        wait_timeout: 600
      tags: [verify]

    - name: "â³ Attendre que MySQL soit prÃªt"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: StatefulSet
        name: mysql
        namespace: "{{ infrastructure_namespace }}"
        wait: true
        wait_condition:
          type: Ready
        wait_timeout: 300
      tags: [verify]

    - name: "â³ Attendre que Redis soit prÃªt"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: StatefulSet
        name: redis-master
        namespace: "{{ infrastructure_namespace }}"
        wait: true
        wait_condition:
          type: Ready
        wait_timeout: 300
      tags: [verify]

    - name: "ğŸ“‹ CrÃ©er les ConfigMaps de connexion pour les microservices"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: infrastructure-config
            namespace: "{{ k8s_namespace }}"
          data:
            SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka.{{ infrastructure_namespace }}.svc.cluster.local:9092"
            SPRING_DATASOURCE_URL: "jdbc:mysql://mysql.{{ infrastructure_namespace }}.svc.cluster.local:3306/springboot_microservices"
            SPRING_REDIS_HOST: "redis-master.{{ infrastructure_namespace }}.svc.cluster.local"
            SPRING_REDIS_PORT: "6379"
      tags: [config]

    - name: "ğŸ” CrÃ©er les Secrets de connexion pour les microservices"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: infrastructure-secrets
            namespace: "{{ k8s_namespace }}"
          type: Opaque
          data:
            SPRING_DATASOURCE_USERNAME: "{{ mysql_username | b64encode }}"
            SPRING_DATASOURCE_PASSWORD: "{{ mysql_password | b64encode }}"
            SPRING_REDIS_PASSWORD: "{{ redis_password | b64encode }}"
      tags: [config]

    - name: "ğŸ“Š Afficher le rÃ©sumÃ© de l'infrastructure"
      debug:
        msg: |
          ğŸ‰ INFRASTRUCTURE DÃ‰PLOYÃ‰E AVEC SUCCÃˆS !
          ========================================
          
          â˜• KAFKA:
          â”œâ”€â”€ Endpoint: kafka.{{ infrastructure_namespace }}.svc.cluster.local:9092
          â”œâ”€â”€ Replicas: 3
          â””â”€â”€ Persistance: 10Gi
          
          ğŸ—„ï¸ MYSQL:
          â”œâ”€â”€ Endpoint: mysql.{{ infrastructure_namespace }}.svc.cluster.local:3306
          â”œâ”€â”€ Base de donnÃ©es: springboot_microservices
          â”œâ”€â”€ Utilisateur: {{ mysql_username }}
          â””â”€â”€ Persistance: 20Gi
          
          ğŸ”´ REDIS:
          â”œâ”€â”€ Endpoint: redis-master.{{ infrastructure_namespace }}.svc.cluster.local:6379
          â”œâ”€â”€ Replicas: 1 master + 2 replicas
          â””â”€â”€ Persistance: 5Gi
          
          ğŸ“Š MONITORING:
          â”œâ”€â”€ Prometheus: monitoring-stack-prometheus.{{ infrastructure_namespace }}.svc.cluster.local:9090
          â”œâ”€â”€ Grafana: monitoring-stack-grafana.{{ infrastructure_namespace }}.svc.cluster.local:3000
          â””â”€â”€ AlertManager: monitoring-stack-alertmanager.{{ infrastructure_namespace }}.svc.cluster.local:9093
          
          ğŸ“ PROCHAINES Ã‰TAPES:
          1. AccÃ©der Ã  Grafana: kubectl port-forward -n {{ infrastructure_namespace }} svc/monitoring-stack-grafana 3000:3000
          2. AccÃ©der Ã  Prometheus: kubectl port-forward -n {{ infrastructure_namespace }} svc/monitoring-stack-prometheus 9090:9090
          3. VÃ©rifier Kafka: kubectl exec -n {{ infrastructure_namespace }} kafka-0 -- kafka-topics.sh --bootstrap-server localhost:9092 --list
          
          âœ… Infrastructure prÃªte pour les microservices !
