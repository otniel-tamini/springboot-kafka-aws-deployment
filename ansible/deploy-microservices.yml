# =================================
# PLAYBOOK PRINCIPAL - DÃ‰PLOIEMENT MICROSERVICES
# =================================

---
- name: "ğŸš€ DÃ©ploiement des microservices Spring Boot Kafka sur EKS"
  hosts: k8s_cluster
  gather_facts: yes
  become: false
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"
    
  pre_tasks:
    - name: "ğŸ” VÃ©rifier la connexion au cluster Kubernetes"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: default
      register: k8s_connection
      
    - name: "âœ… Cluster Kubernetes accessible"
      debug:
        msg: "Connexion au cluster EKS Ã©tablie avec succÃ¨s"
      when: k8s_connection is succeeded
      
    - name: "ğŸ“‹ Afficher les informations du dÃ©ploiement"
      debug:
        msg: |
          ğŸš€ DÃ‰PLOIEMENT MICROSERVICES SPRING BOOT KAFKA
          ================================================
          ğŸŒ Environnement: {{ deployment_environment }}
          ğŸ—ï¸  Namespace: {{ k8s_namespace }}
          ğŸ“Š Services Ã  dÃ©ployer: {{ groups['microservices'] | length }}
          ğŸ”§ Version: {{ common_image_tag }}

  tasks:
    - name: "ğŸ“¦ DÃ©ployer les microservices"
      include_role:
        name: k8s-microservice
      vars:
        service_name: "{{ hostvars[item]['service_name'] }}"
        image: "{{ hostvars[item]['image'] }}"
        image_tag: "{{ hostvars[item]['image_tag'] | default(common_image_tag) }}"
        port: "{{ hostvars[item]['port'] }}"
        replicas: "{{ hostvars[item]['replicas'] }}"
        environment: "{{ hostvars[item]['environment'] | default({}) | combine(global_environment) }}"
        secret_environment: "{{ hostvars[item]['secret_environment'] | default({}) | combine(global_secret_environment) }}"
        resources: "{{ hostvars[item]['resources'] | default({}) }}"
        health_check: "{{ hostvars[item]['health_check'] }}"
        monitoring: "{{ hostvars[item]['monitoring'] | default({'enabled': true}) }}"
      loop: "{{ groups['microservices'] }}"
      loop_control:
        loop_var: item
        label: "{{ hostvars[item]['service_name'] }}"
      tags: [deploy]

  post_tasks:
    - name: "ğŸ“Š RÃ©cupÃ©rer l'Ã©tat de tous les dÃ©ploiements"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ k8s_namespace }}"
      register: all_deployments
      
    - name: "ğŸ“ˆ RÃ©cupÃ©rer l'Ã©tat de tous les services"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ k8s_namespace }}"
      register: all_services
      
    - name: "ğŸƒ RÃ©cupÃ©rer l'Ã©tat de tous les pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - "app.kubernetes.io/part-of=springboot-kafka-microservices"
      register: all_pods

    - name: "ğŸ“‹ Afficher le rÃ©sumÃ© du dÃ©ploiement"
      debug:
        msg: |
          ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS !
          ====================================
          
          ğŸ“Š STATISTIQUES:
          â”œâ”€â”€ DÃ©ploiements: {{ all_deployments.resources | length }}
          â”œâ”€â”€ Services: {{ all_services.resources | length }}
          â”œâ”€â”€ Pods Total: {{ all_pods.resources | length }}
          â””â”€â”€ Pods Actifs: {{ all_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}
          
          ğŸš€ SERVICES DÃ‰PLOYÃ‰S:
          {% for deployment in all_deployments.resources %}
          â”œâ”€â”€ {{ deployment.metadata.name }}
          â”‚   â”œâ”€â”€ Replicas: {{ deployment.status.replicas | default(0) }}/{{ deployment.spec.replicas }}
          â”‚   â”œâ”€â”€ PrÃªt: {{ deployment.status.readyReplicas | default(0) }}
          â”‚   â””â”€â”€ Image: {{ deployment.spec.template.spec.containers[0].image }}
          {% endfor %}
          
          ğŸŒ ACCÃˆS AUX SERVICES:
          {% for service in all_services.resources %}
          â”œâ”€â”€ {{ service.metadata.name }}: {{ service.spec.clusterIP }}:{{ service.spec.ports[0].port }}
          {% endfor %}
          
          ğŸ“ PROCHAINES Ã‰TAPES:
          1. VÃ©rifier les logs: kubectl logs -n {{ k8s_namespace }} -l app.kubernetes.io/part-of=springboot-kafka-microservices
          2. Port-forward pour tests: kubectl port-forward -n {{ k8s_namespace }} svc/api-gateway 8080:8080
          3. Surveiller les mÃ©triques: kubectl port-forward -n {{ k8s_namespace }} svc/prometheus 9090:9090
          
          âœ… Tous les microservices sont opÃ©rationnels !

---
# =================================
# PLAYBOOK DE MONITORING ET VÃ‰RIFICATIONS
# =================================

- name: "ğŸ“Š VÃ©rification de santÃ© des microservices"
  hosts: k8s_cluster
  gather_facts: no
  become: false
  
  tasks:
    - name: "ğŸ¥ VÃ©rifier la santÃ© de chaque microservice"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - "app={{ hostvars[item]['service_name'] }}"
      register: service_health
      loop: "{{ groups['microservices'] }}"
      loop_control:
        loop_var: item
        label: "{{ hostvars[item]['service_name'] }}"
        
    - name: "ğŸ“ˆ Afficher le statut de santÃ©"
      debug:
        msg: |
          ğŸ¥ RAPPORT DE SANTÃ‰ - {{ hostvars[item]['service_name'] }}
          ================================================
          ğŸƒ Pods en cours: {{ service_health.results[loop_index].resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}
          ğŸ“Š Pods total: {{ service_health.results[loop_index].resources | length }}
          {% for pod in service_health.results[loop_index].resources %}
          â”œâ”€â”€ {{ pod.metadata.name }}: {{ pod.status.phase }}
          {% endfor %}
      loop: "{{ groups['microservices'] }}"
      loop_control:
        loop_var: item
        index_var: loop_index
        label: "{{ hostvars[item]['service_name'] }}"
      tags: [health]
