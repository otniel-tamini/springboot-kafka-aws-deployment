# =================================
# PLAYBOOK PRINCIPAL - DÃ‰PLOIEMENT COMPLET
# =================================

---
- name: "ğŸš€ DÃ©ploiement complet - Infrastructure + Microservices"
  hosts: k8s_cluster
  gather_facts: yes
  become: false
  
  vars:
    deployment_start_time: "{{ ansible_date_time.iso8601 }}"
    
  tasks:
    - name: "ğŸ¯ DÃ©marrage du dÃ©ploiement complet"
      debug:
        msg: |
          ğŸš€ DÃ‰PLOIEMENT COMPLET SPRINGBOOT KAFKA MICROSERVICES
          =====================================================
          
          ğŸ“… Heure de dÃ©but: {{ deployment_start_time }}
          ğŸŒ Environnement: {{ environment }}
          ğŸ—ï¸  Namespace Microservices: {{ k8s_namespace }}
          ğŸ—ï¸  Namespace Infrastructure: infrastructure
          
          ğŸ“¦ COMPOSANTS Ã€ DÃ‰PLOYER:
          â”œâ”€â”€ ğŸ—„ï¸  Infrastructure (Kafka, MySQL, Redis, Monitoring)
          â””â”€â”€ ğŸš€ Microservices ({{ groups['microservices'] | length }} services)

# =================================
# Ã‰TAPE 1: DÃ‰PLOIEMENT INFRASTRUCTURE
# =================================
- import_playbook: deploy-infrastructure.yml
  tags: [infrastructure]

# =================================
# Ã‰TAPE 2: ATTENTE ET VÃ‰RIFICATION
# =================================
- name: "â³ VÃ©rification de l'infrastructure avant dÃ©ploiement des microservices"
  hosts: k8s_cluster
  gather_facts: no
  become: false
  
  tasks:
    - name: "ğŸ” VÃ©rifier que tous les services d'infrastructure sont prÃªts"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: infrastructure
        label_selectors:
          - "app.kubernetes.io/instance in (kafka,mysql,redis,monitoring-stack)"
      register: infrastructure_services
      
    - name: "ğŸ“Š Afficher l'Ã©tat de l'infrastructure"
      debug:
        msg: |
          ğŸ” VÃ‰RIFICATION INFRASTRUCTURE
          ==============================
          âœ… Services trouvÃ©s: {{ infrastructure_services.resources | length }}
          
          ğŸ“‹ SERVICES ACTIFS:
          {% for service in infrastructure_services.resources %}
          â”œâ”€â”€ {{ service.metadata.name }}: {{ service.spec.clusterIP }}
          {% endfor %}
          
          â­ï¸  PrÃªt pour le dÃ©ploiement des microservices...

    - name: "â³ Pause de 30 secondes pour stabilisation"
      pause:
        seconds: 30
        prompt: "Attente de stabilisation de l'infrastructure..."

# =================================
# Ã‰TAPE 3: DÃ‰PLOIEMENT MICROSERVICES
# =================================
- import_playbook: deploy-microservices.yml
  tags: [microservices]

# =================================
# Ã‰TAPE 4: CONFIGURATION LOAD BALANCING
# =================================
- import_playbook: deploy-ingress.yml
  tags: [ingress, load-balancing]

# =================================
# Ã‰TAPE 5: VÃ‰RIFICATIONS FINALES
# =================================
- name: "âœ… VÃ©rifications finales et tests de connectivitÃ©"
  hosts: k8s_cluster
  gather_facts: no
  become: false
  
  vars:
    deployment_end_time: "{{ ansible_date_time.iso8601 }}"
    
  tasks:
    - name: "ğŸ” VÃ©rifier la connectivitÃ© Kafka"
      kubernetes.core.k8s_exec:
        namespace: infrastructure
        pod: kafka-0
        command: |
          kafka-topics.sh --bootstrap-server localhost:9092 --list
      register: kafka_topics
      ignore_errors: yes
      
    - name: "ğŸ” VÃ©rifier la connectivitÃ© MySQL"
      kubernetes.core.k8s_exec:
        namespace: infrastructure
        pod: mysql-0
        command: |
          mysql -u {{ mysql_username }} -p{{ mysql_password }} -e "SHOW DATABASES;"
      register: mysql_databases
      ignore_errors: yes
      
    - name: "ğŸ” VÃ©rifier la connectivitÃ© Redis"
      kubernetes.core.k8s_exec:
        namespace: infrastructure
        pod: redis-master-0
        command: |
          redis-cli -a {{ redis_password }} ping
      register: redis_ping
      ignore_errors: yes

    - name: "ğŸ“Š RÃ©cupÃ©rer l'Ã©tat final de tous les dÃ©ploiements"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ k8s_namespace }}"
      register: final_deployments
      
    - name: "ğŸ“ˆ RÃ©cupÃ©rer l'Ã©tat final de tous les pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        label_selectors:
          - "app.kubernetes.io/part-of=springboot-kafka-microservices"
      register: final_pods

    - name: "ğŸ‰ Rapport final de dÃ©ploiement"
      debug:
        msg: |
          ğŸ‰ DÃ‰PLOIEMENT COMPLET TERMINÃ‰ !
          ================================
          
          â±ï¸  DURÃ‰E: {{ deployment_start_time }} â†’ {{ deployment_end_time }}
          
          ğŸ—„ï¸ INFRASTRUCTURE:
          â”œâ”€â”€ â˜• Kafka: {{ 'OK' if kafka_topics is succeeded else 'ERREUR' }}
          â”œâ”€â”€ ğŸ—„ï¸  MySQL: {{ 'OK' if mysql_databases is succeeded else 'ERREUR' }}
          â”œâ”€â”€ ğŸ”´ Redis: {{ 'OK' if redis_ping is succeeded else 'ERREUR' }}
          â””â”€â”€ ğŸ“Š Monitoring: DÃ©ployÃ©
          
          ğŸš€ MICROSERVICES:
          â”œâ”€â”€ ğŸ“¦ DÃ©ploiements: {{ final_deployments.resources | length }}
          â”œâ”€â”€ ğŸƒ Pods Total: {{ final_pods.resources | length }}
          â”œâ”€â”€ âœ… Pods Actifs: {{ final_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}
          â””â”€â”€ âŒ Pods en Erreur: {{ final_pods.resources | selectattr('status.phase', 'equalto', 'Failed') | list | length }}
          
          ğŸ“Š DÃ‰TAIL DES SERVICES:
          {% for deployment in final_deployments.resources %}
          â”œâ”€â”€ {{ deployment.metadata.name }}
          â”‚   â”œâ”€â”€ ğŸ“Š Replicas: {{ deployment.status.readyReplicas | default(0) }}/{{ deployment.spec.replicas }}
          â”‚   â”œâ”€â”€ ğŸ–¼ï¸  Image: {{ deployment.spec.template.spec.containers[0].image }}
          â”‚   â””â”€â”€ ğŸ”— Status: {{ 'Ready' if deployment.status.readyReplicas == deployment.spec.replicas else 'Not Ready' }}
          {% endfor %}
          
          ğŸŒ POINTS D'ACCÃˆS:
          â”œâ”€â”€ ğŸšª API Gateway: kubectl port-forward -n {{ k8s_namespace }} svc/api-gateway 8080:8080
          â”œâ”€â”€ ğŸ“Š Grafana: kubectl port-forward -n infrastructure svc/monitoring-stack-grafana 3000:3000
          â”œâ”€â”€ ğŸ“ˆ Prometheus: kubectl port-forward -n infrastructure svc/monitoring-stack-prometheus 9090:9090
          â””â”€â”€ ğŸ” Service Registry: kubectl port-forward -n {{ k8s_namespace }} svc/service-registry 8761:8761
          
          ğŸ“‹ COMMANDES UTILES:
          â”œâ”€â”€ Logs microservices: kubectl logs -n {{ k8s_namespace }} -l app.kubernetes.io/part-of=springboot-kafka-microservices -f
          â”œâ”€â”€ Ã‰tat des pods: kubectl get pods -n {{ k8s_namespace }} -o wide
          â”œâ”€â”€ Services: kubectl get svc -n {{ k8s_namespace }}
          â””â”€â”€ Ã‰vÃ©nements: kubectl get events -n {{ k8s_namespace }} --sort-by='.lastTimestamp'
          
          ğŸ¯ TESTS RECOMMANDÃ‰S:
          1. Test API Gateway: curl http://localhost:8080/actuator/health
          2. Test Service Registry: curl http://localhost:8761/actuator/health
          3. VÃ©rifier les mÃ©triques Prometheus
          4. Consulter les dashboards Grafana
          
          {{ 'âœ… DÃ‰PLOIEMENT RÃ‰USSI !' if final_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == final_pods.resources | length else 'âš ï¸  DÃ‰PLOIEMENT PARTIEL - VÃ©rifier les pods en erreur' }}

    - name: "ğŸ“ CrÃ©er un fichier de rapport de dÃ©ploiement"
      copy:
        content: |
          # Rapport de DÃ©ploiement - {{ deployment_end_time }}
          
          ## Infrastructure
          - Kafka: {{ 'OK' if kafka_topics is succeeded else 'ERREUR' }}
          - MySQL: {{ 'OK' if mysql_databases is succeeded else 'ERREUR' }}
          - Redis: {{ 'OK' if redis_ping is succeeded else 'ERREUR' }}
          
          ## Microservices
          {% for deployment in final_deployments.resources %}
          - {{ deployment.metadata.name }}: {{ deployment.status.readyReplicas | default(0) }}/{{ deployment.spec.replicas }} replicas
          {% endfor %}
          
          ## Commandes d'AccÃ¨s
          ```bash
          # API Gateway
          kubectl port-forward -n {{ k8s_namespace }} svc/api-gateway 8080:8080
          
          # Grafana (admin/{{ grafana_admin_password }})
          kubectl port-forward -n infrastructure svc/monitoring-stack-grafana 3000:3000
          
          # Prometheus
          kubectl port-forward -n infrastructure svc/monitoring-stack-prometheus 9090:9090
          ```
        dest: "/tmp/deployment-report-{{ ansible_date_time.epoch }}.md"
      delegate_to: localhost
