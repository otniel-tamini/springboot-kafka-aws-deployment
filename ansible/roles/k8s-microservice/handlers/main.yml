# =================================
# HANDLERS - RÃ”LE MICROSERVICE KUBERNETES
# =================================

- name: "ğŸ”„ RedÃ©marrer le dÃ©ploiement"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ service_name }}"
        namespace: "{{ k8s_namespace }}"
        annotations:
          kubectl.kubernetes.io/restartedAt: "{{ ansible_date_time.iso8601 }}"
      spec:
        template:
          metadata:
            annotations:
              kubectl.kubernetes.io/restartedAt: "{{ ansible_date_time.iso8601 }}"

- name: "â³ Attendre le redÃ©marrage complet"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "{{ service_name }}"
    namespace: "{{ k8s_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: "ğŸ” VÃ©rifier la santÃ© du service"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ k8s_namespace }}"
    label_selectors:
      - "app={{ service_name }}"
  register: service_pods

- name: "ğŸ“Š Afficher le statut aprÃ¨s redÃ©marrage"
  debug:
    msg: |
      ğŸ”„ Service redÃ©marrÃ©: {{ service_name }}
      ğŸƒ Pods actifs: {{ service_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}
      âœ… RedÃ©marrage terminÃ©
